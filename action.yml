name: 'OfferFetcher Action'
description: 'Fetch offers'
author: 'kaspioffers'

branding:
  icon: 'shopping-cart'
  color: 'blue'

inputs:
  ghcr-token:
    description: 'GitHub Personal Access Token with read:packages permission'
    required: true
  database-connection-string:
    description: 'PostgreSQL database connection string for OfferFetcher'
    required: true
  timescaledb-connection-string:
    description: 'TimescaleDB connection string for time-series data'
    required: false
    default: ''
  batch-size:
    description: 'Number of offers to fetch per batch'
    required: false
    default: '100'
  scan-interval-minutes:
    description: 'Minutes between scan intervals'
    required: false
    default: '15'
  api-timeout:
    description: 'Maximum runtime in seconds before timing out'
    required: false
    default: '300'
  proxy-url:
    description: 'Optional proxy server URL'
    required: false
    default: ''
  proxy-username:
    description: 'Optional proxy username'
    required: false
    default: ''
  proxy-password:
    description: 'Optional proxy password'
    required: false
    default: ''

outputs:
  status:
    description: 'Status of the fetch operation (success/failure)'
    value: ${{ steps.run-action.outputs.status }}
  message:
    description: 'Detailed message about the operation result'
    value: ${{ steps.run-action.outputs.message }}

runs:
  using: 'composite'
  steps:
    - name: Log in to GitHub Container Registry
      shell: bash
      run: |
        echo "${{ inputs.ghcr-token }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
    
    - name: Pull Docker image
      shell: bash
      run: |
        docker pull ghcr.io/kaspioffers/offerfetcher/api-service:latest
    
    - name: Run OfferFetcher
      id: run-action
      shell: bash
      run: |
        docker run --rm \
          ghcr.io/kaspioffers/offerfetcher/api-service:latest \
          "${{ inputs.database-connection-string }}" \
          "${{ inputs.timescaledb-connection-string }}" \
          "${{ inputs.batch-size }}" \
          "${{ inputs.scan-interval-minutes }}" \
          "${{ inputs.api-timeout }}" \
          "${{ inputs.proxy-url }}" \
          "${{ inputs.proxy-username }}" \
          "${{ inputs.proxy-password }}"
    
    - name: Logout from GHCR
      shell: bash
      if: always()
      run: docker logout ghcr.io
